<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Recibo de Pagamento a Autônomo - RPA</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .rpa { border: 2px solid #000; padding: 20px; width: 900px; }
    h2 { text-align: center; }
    h3 { margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #000; }
    th, td { padding: 5px; text-align: left; }
    .assinatura { margin-top: 40px; }
    button { margin-top: 15px; padding: 10px; margin-right: 10px; }
    input, select { width: 100%; padding: 5px; margin-top: 5px; }
    #mensagem { color: green; font-weight: bold; margin-top: 10px; }
    .campos-anteriores { 
      margin-top: 15px; 
      padding: 15px; 
      border: 1px dashed #666; 
      background-color: #f9f9f9;
    }
    .campos-anteriores.hidden { display: none; }
    .label-group { margin-top: 10px; }
    .label-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    .info-box { 
      margin-top: 15px; 
      padding: 10px; 
      background-color: #f0f8ff; 
      border: 1px solid #ccc;
      font-size: 12px;
    }
    .highlight { background-color: #ffffcc; padding: 3px; font-weight: bold; }
    .reducao-info { 
      background-color: #e8f5e8; 
      border-left: 4px solid #4CAF50;
      padding: 8px;
      margin: 5px 0;
    }
    @media print { .no-print { display: none; } }
  </style>
</head>
<body>
  <div class="rpa">
    <h2>RECIBO DE PAGAMENTO A AUTÔNOMO - RPA</h2>

    <div class="label-group">
      <label>Nº do RPA:</label>
      <input type="text" id="numeroRPA" value="0001">
    </div>

    <div class="label-group">
      <label>Nome do Prestador:</label>
      <input type="text" id="nome">
    </div>

    <div class="label-group">
      <label>CPF:</label>
      <input type="text" id="cpf" placeholder="000.000.000-00">
    </div>

    <div class="label-group">
      <label>Tomador do Serviço:</label>
      <input type="text" id="tomador">
    </div>

    <div class="label-group">
      <label>CNPJ do Tomador:</label>
      <input type="text" id="cnpjTomador" placeholder="00.000.000/0000-00">
    </div>

    <div class="label-group">
      <label>Local da Prestação:</label>
      <input type="text" id="local">
    </div>

    <h3>RECEBI DA EMPRESA ACIMA IDENTIFICADA, PELA PRESTAÇÃO DOS SERVIÇOS</h3>

    <div class="label-group">
      <label>Tipo de Serviço:</label>
      <input type="text" id="servico">
    </div>

    <div class="label-group">
      <label>Valor Bruto (R$):</label>
      <input type="number" id="valor" step="0.01">
    </div>

    <div class="label-group">
      <label>Alíquota de ISS (%):</label>
      <input type="number" id="aliquotaISS" step="0.01" value="5">
    </div>

    <div class="label-group">
      <label>ISS Retido?</label>
      <select id="issRetido">
        <option value="sim">Sim</option>
        <option value="nao">Não</option>
      </select>
    </div>

    <div class="label-group">
      <label>Possui RPA anteriores no mesmo mês?</label>
      <div style="display: flex; gap: 20px; margin-top: 10px;">
        <label style="display: flex; align-items: center; font-weight: normal;">
          <input type="radio" name="possuiRPA" value="sim" onchange="toggleCamposAnteriores()"> Sim
        </label>
        <label style="display: flex; align-items: center; font-weight: normal;">
          <input type="radio" name="possuiRPA" value="nao" onchange="toggleCamposAnteriores()" checked> Não
        </label>
      </div>
    </div>

    <div id="camposAnteriores" class="campos-anteriores hidden">
      <div class="label-group">
        <label>Valor da base acumulada anterior (R$):</label>
        <input type="number" id="baseAnterior" step="0.01" value="0">
      </div>
      
      <div class="label-group">
        <label>Valor do IRRF acumulado anterior (R$):</label>
        <input type="number" id="irrfAnterior" step="0.01" value="0">
      </div>
    </div>

    <div class="no-print">
      <button onclick="gerarRecibo()">Gerar Recibo</button>
      <button onclick="limparCampos()">Limpar Campos</button>
      <button onclick="window.print()">Imprimir / Salvar em PDF</button>
    </div>

    <div id="resultado"></div>
    <div id="mensagem"></div>
  </div>

  <script>
    // Função para mostrar/ocultar campos de RPA anteriores
    function toggleCamposAnteriores() {
      const possuiRPA = document.querySelector('input[name="possuiRPA"]:checked');
      const camposAnteriores = document.getElementById("camposAnteriores");
      
      if (possuiRPA && possuiRPA.value === "sim") {
        camposAnteriores.classList.remove("hidden");
      } else {
        camposAnteriores.classList.add("hidden");
        // Limpa os campos quando ocultar
        document.getElementById("baseAnterior").value = "0";
        document.getElementById("irrfAnterior").value = "0";
      }
    }

    // Função para obter o valor do campo Possui RPA
    function getPossuiRPA() {
      const possuiRPA = document.querySelector('input[name="possuiRPA"]:checked');
      return possuiRPA ? possuiRPA.value : "nao";
    }

    // Função para limpar todos os campos e o recibo
    function limparCampos() {
      document.getElementById("numeroRPA").value = "0001";
      document.getElementById("nome").value = "";
      document.getElementById("cpf").value = "";
      document.getElementById("tomador").value = "";
      document.getElementById("cnpjTomador").value = "";
      document.getElementById("local").value = "";
      document.getElementById("servico").value = "";
      document.getElementById("valor").value = "";
      document.getElementById("aliquotaISS").value = "5";
      document.getElementById("issRetido").value = "sim";
      
      // Resetar radio buttons para "Não"
      const radioNao = document.querySelector('input[name="possuiRPA"][value="nao"]');
      if (radioNao) radioNao.checked = true;
      
      document.getElementById("baseAnterior").value = "0";
      document.getElementById("irrfAnterior").value = "0";
      document.getElementById("camposAnteriores").classList.add("hidden");
      document.getElementById("resultado").innerHTML = "";
      document.getElementById("mensagem").innerText = "Campos limpos com sucesso!";
      setTimeout(() => { document.getElementById("mensagem").innerText = ""; }, 3000);
    }

    // Formatar CPF
    function formatarCPF(cpf) {
      cpf = cpf.replace(/\D/g, '');
      if (cpf.length === 11) {
        return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
      }
      return cpf;
    }

    // Formatar CNPJ
    function formatarCNPJ(cnpj) {
      cnpj = cnpj.replace(/\D/g, '');
      if (cnpj.length === 14) {
        return cnpj.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");
      }
      return cnpj;
    }

    // Faixas INSS 2026 (progressivas) - CORRIGIDO: Apenas uma faixa de 11% até o teto
    const inssFaixas = [
      { limite: 8537.55, aliquota: 0.11, descricao: "11% até R$ 8.537,55" }
    ];

    // Tabela IR 2026 - conforme legislação vigente
    const faixasIR = [
      { limite: 2428.80, aliquota: 0.0, descricao: "0% (Isento)" },
      { limite: 2826.65, aliquota: 0.075, descricao: "7,5%" },
      { limite: 3751.05, aliquota: 0.15, descricao: "15%" },
      { limite: 4664.68, aliquota: 0.225, descricao: "22,5%" },
      { limite: Infinity, aliquota: 0.275, descricao: "27,5%" }
    ];

    // Parâmetros para redução/isenção conforme Lei 2026
    const PARAMETROS_IR = {
      LIMITE_ISENCAO: 5000.00,
      LIMITE_REDUCAO: 7350.00,
      REDUCAO_BASE: 978.62,
      REDUCAO_COEFICIENTE: 0.133145,
      DESCRICAO_ISENCAO: "Isenção IRRF (Lei 2026 - Base ≤ R$ 5.000,00)",
      DESCRICAO_REDUCAO: "Redução IRRF (Lei 2026 - Base R$ 5.000,01 a R$ 7.350,00)"
    };

    // Função para calcular INSS e retornar também a alíquota efetiva
    function calcularINSS(salario) {
      let restante = salario, contribuicao = 0, anterior = 0;
      let aliquotaEfetiva = 0;
      let descricaoDetalhada = "";
      
      for (let faixa of inssFaixas) {
        if (restante > faixa.limite) {
          contribuicao += (faixa.limite - anterior) * faixa.aliquota;
          anterior = faixa.limite;
          descricaoDetalhada = `11% aplicado sobre R$ ${faixa.limite.toFixed(2)} (teto máximo)`;
        } else {
          contribuicao += (restante - anterior) * faixa.aliquota;
          // Calcula alíquota efetiva (média ponderada)
          if (salario > 0) {
            aliquotaEfetiva = contribuicao / salario;
          }
          descricaoDetalhada = `11% aplicado sobre R$ ${salario.toFixed(2)}`;
          break;
        }
      }
      
      return {
        valor: contribuicao,
        aliquotaEfetiva: aliquotaEfetiva,
        descricaoDetalhada: descricaoDetalhada,
        descricao: inssFaixas[0].descricao
      };
    }

    // Função para calcular IRRF e retornar também informações detalhadas
    function calcularIRRF(base, possuiReducao = true) {
      let impostoBruto = 0;
      let anterior = 0;
      let faixaAplicada = null;
      let reducaoAplicada = 0;
      let isencaoAplicada = false;
      let tipoCalculo = "Normal";
      let descricaoDetalhada = "";
      
      // Cálculo do imposto bruto conforme tabela progressiva
      for (let faixa of faixasIR) {
        if (base > faixa.limite) {
          impostoBruto += (faixa.limite - anterior) * faixa.aliquota;
          anterior = faixa.limite;
        } else {
          if (base > 0) {
            impostoBruto += (base - anterior) * faixa.aliquota;
            faixaAplicada = faixa;
          }
          break;
        }
      }
      
      // Aplicar isenção ou redução conforme Lei 2026
      let impostoFinal = impostoBruto;
      
      if (possuiReducao) {
        if (base <= PARAMETROS_IR.LIMITE_ISENCAO) {
          impostoFinal = 0;
          isencaoAplicada = true;
          tipoCalculo = "Isenção";
          descricaoDetalhada = PARAMETROS_IR.DESCRICAO_ISENCAO;
        } else if (base <= PARAMETROS_IR.LIMITE_REDUCAO) {
          reducaoAplicada = PARAMETROS_IR.REDUCAO_BASE - (PARAMETROS_IR.REDUCAO_COEFICIENTE * base);
          impostoFinal = impostoBruto - reducaoAplicada;
          if (impostoFinal < 0) impostoFinal = 0;
          
          tipoCalculo = "Redução";
          descricaoDetalhada = `${PARAMETROS_IR.DESCRICAO_REDUCAO}<br>Redução calculada: R$ ${reducaoAplicada.toFixed(2)}<br>Imposto bruto: R$ ${impostoBruto.toFixed(2)} - Redução = R$ ${impostoFinal.toFixed(2)}`;
        } else {
          tipoCalculo = "Normal";
          descricaoDetalhada = `Base acima de R$ 7.350,00 - aplicada tabela normal`;
        }
      }
      
      return {
        valor: impostoFinal,
        impostoBruto: impostoBruto,
        faixaAplicada: faixaAplicada,
        reducaoAplicada: reducaoAplicada,
        isencaoAplicada: isencaoAplicada,
        tipoCalculo: tipoCalculo,
        descricaoDetalhada: descricaoDetalhada,
        baseCalculo: base
      };
    }

    function gerarRecibo() {
      let numeroRPA = document.getElementById("numeroRPA").value;
      let nome = document.getElementById("nome").value;
      let cpf = document.getElementById("cpf").value;
      let tomador = document.getElementById("tomador").value;
      let cnpjTomador = document.getElementById("cnpjTomador").value;
      let local = document.getElementById("local").value;
      let servico = document.getElementById("servico").value;
      let salario = parseFloat(document.getElementById("valor").value);
      let aliquotaISS = parseFloat(document.getElementById("aliquotaISS").value) / 100;
      let issRetido = document.getElementById("issRetido").value;
      
      // Obter valor do radio button
      let possuiAnteriores = getPossuiRPA();
      let baseAnterior = possuiAnteriores === "sim" ? parseFloat(document.getElementById("baseAnterior").value) || 0 : 0;
      let irrfAnterior = possuiAnteriores === "sim" ? parseFloat(document.getElementById("irrfAnterior").value) || 0 : 0;

      if (isNaN(salario)) {
        alert("Digite o valor bruto!");
        return;
      }

      // Validação dos campos obrigatórios
      if (!nome || !cpf || !tomador || !cnpjTomador || !local || !servico) {
        alert("Preencha todos os campos obrigatórios!");
        return;
      }

      // Cálculos para o RPA atual
      let inssResultado = calcularINSS(salario);
      let inss = inssResultado.valor;
      let base = salario - inss;
      
      let irrfResultado = calcularIRRF(base, true);
      let impostoFinal = irrfResultado.valor;

      // Cálculos acumulados (considerando RPA anteriores)
      let baseAcumulada = baseAnterior + base;
      let irrfAcumulado = irrfAnterior + impostoFinal;
      let iss = issRetido === "sim" ? salario * aliquotaISS : 0;
      let liquido = salario - inss - impostoFinal - iss;

      // Formatar CPF e CNPJ
      let cpfFormatado = formatarCPF(cpf);
      let cnpjFormatado = formatarCNPJ(cnpjTomador);

      // Determinar descrição da alíquota do INSS
      let descricaoINSS = inssResultado.descricao;
      let aliquotaINSSPercentual = (inssResultado.aliquotaEfetiva * 100).toFixed(2);
      
      // Determinar descrição da alíquota do IRRF
      let descricaoIRRF = "";
      let classeIRRF = "";
      
      if (irrfResultado.isencaoAplicada) {
        descricaoIRRF = `<span class="highlight">${PARAMETROS_IR.DESCRICAO_ISENCAO}</span>`;
        classeIRRF = "reducao-info";
      } else if (irrfResultado.tipoCalculo === "Redução") {
        descricaoIRRF = `<span class="highlight">${PARAMETROS_IR.DESCRICAO_REDUCAO}</span>`;
        classeIRRF = "reducao-info";
      } else if (irrfResultado.faixaAplicada) {
        descricaoIRRF = `Faixa ${irrfResultado.faixaAplicada.descricao}`;
      }

      let tabelaAnteriores = "";
      if (possuiAnteriores === "sim") {
        tabelaAnteriores = `
          <h4>Acumulado com RPA(s) Anterior(es)</h4>
          <table>
            <tr>
              <th>Descrição</th>
              <th>Base Anterior (R$)</th>
              <th>Base Atual (R$)</th>
              <th>Base Acumulada (R$)</th>
              <th>IRRF Anterior (R$)</th>
              <th>IRRF Atual (R$)</th>
              <th>IRRF Acumulado (R$)</th>
            </tr>
            <tr>
              <td>Valores</td>
              <td>${baseAnterior.toFixed(2)}</td>
              <td>${base.toFixed(2)}</td>
              <td><strong>${baseAcumulada.toFixed(2)}</strong></td>
              <td>${irrfAnterior.toFixed(2)}</td>
              <td>${impostoFinal.toFixed(2)}</td>
              <td><strong>${irrfAcumulado.toFixed(2)}</strong></td>
            </tr>
          </table>
        `;
      }

      document.getElementById("resultado").innerHTML = `
        <h3>Recibo Nº ${numeroRPA}</h3>
        <table>
          <tr><td><strong>Prestador:</strong></td><td>${nome} - CPF: ${cpfFormatado}</td></tr>
          <tr><td><strong>Tomador do Serviço:</strong></td><td>${tomador} - CNPJ: ${cnpjFormatado}</td></tr>
          <tr><td><strong>Local da Prestação:</strong></td><td style="font-size:12px;">${local}</td></tr>
          <tr><td><strong>Serviço:</strong></td><td>${servico}</td></tr>
          <tr><td><strong>Possui RPA(s) anterior(es) no mês:</strong></td><td>${possuiAnteriores === "sim" ? "Sim" : "Não"}</td></tr>
        </table>
        
        ${tabelaAnteriores}
        
        <h4>Cálculos do RPA Atual</h4>
        <table>
          <tr><th>Descrição</th><th>Base (R$)</th><th>Alíquota Aplicada</th><th>Valor (R$)</th></tr>
          <tr><td>Valor do Serviço</td><td>${salario.toFixed(2)}</td><td>-</td><td>${salario.toFixed(2)}</td></tr>
          <tr><td>INSS</td><td>${salario.toFixed(2)}</td><td>${descricaoINSS}<br><small>${inssResultado.descricaoDetalhada}</small></td><td>${inss.toFixed(2)}</td></tr>
          <tr><td>IRRF</td><td>${base.toFixed(2)}</td><td class="${classeIRRF}">${descricaoIRRF}<br><small>${irrfResultado.descricaoDetalhada}</small></td><td>${impostoFinal.toFixed(2)}</td></tr>
          <tr><td>ISS</td><td>${salario.toFixed(2)}</td><td>${(aliquotaISS * 100).toFixed(2)}%</td><td>${iss.toFixed(2)}</td></tr>
          <tr><td colspan="3"><strong>Valor Líquido a Receber:</strong></td><td><strong>R$ ${liquido.toFixed(2)}</strong></td></tr>
        </table>
        
        ${possuiAnteriores === "sim" ? `
        <div class="info-box">
          <strong>Resumo Acumulado:</strong>
          <p>Base total acumulada: R$ ${baseAcumulada.toFixed(2)}</p>
          <p>IRRF total acumulado: R$ ${irrfAcumulado.toFixed(2)}</p>
        </div>
        ` : ''}
        
        <div class="info-box">
          <strong>Detalhes das Alíquotas Aplicadas (Conforme Lei 2026):</strong>
          
          <div style="margin-top: 10px;">
            <strong>INSS (Contribuição Previdenciária):</strong>
            <p>• Alíquota: 11% sobre o valor bruto</p>
            <p>• Teto máximo: R$ 8.537,55</p>
            <p>• Alíquota efetiva aplicada: <strong>${aliquotaINSSPercentual}%</strong></p>
          </div>
          
          <div style="margin-top: 10px;">
            <strong>IRRF (Imposto de Renda Retido na Fonte):</strong>
            <p>• Base de cálculo: Valor bruto - INSS = R$ ${base.toFixed(2)}</p>
            ${irrfResultado.isencaoAplicada ? 
              `<p class="reducao-info">• <strong>ISENÇÃO APLICADA:</strong> Base de cálculo ≤ R$ 5.000,00 (Lei 2026)</p>` : 
              irrfResultado.tipoCalculo === "Redução" ? 
              `<p class="reducao-info">• <strong>REDUÇÃO APLICADA:</strong> Base entre R$ 5.000,01 e R$ 7.350,00</p>
               <p>• Fórmula da redução: R$ 978,62 - (0,133145 × Base)</p>
               <p>• Redução calculada: R$ ${irrfResultado.reducaoAplicada.toFixed(2)}</p>` : 
              `<p>• <strong>TABELA NORMAL APLICADA:</strong> Base > R$ 7.350,00</p>`
            }
            ${irrfResultado.faixaAplicada ? 
              `<p>• Faixa aplicada: ${irrfResultado.faixaAplicada.descricao}</p>
               <p>• Imposto bruto (antes de redução): R$ ${irrfResultado.impostoBruto.toFixed(2)}</p>` : 
              ''
            }
          </div>
          
          <div style="margin-top: 10px;">
            <strong>Tabela IRRF 2026:</strong>
            <ul style="margin: 5px 0;">
              <li>Até R$ 2.428,80: Isento</li>
              <li>De R$ 2.428,81 até R$ 2.826,65: 7,5%</li>
              <li>De R$ 2.826,66 até R$ 3.751,05: 15%</li>
              <li>De R$ 3.751,06 até R$ 4.664,68: 22,5%</li>
              <li>Acima de R$ 4.664,68: 27,5%</li>
            </ul>
          </div>
          
          <div style="margin-top: 10px;">
            <strong>Benefícios Lei 2026:</strong>
            <ul style="margin: 5px 0;">
              <li>Isenção total: Base de cálculo ≤ R$ 5.000,00</li>
              <li>Redução progressiva: Base entre R$ 5.000,01 e R$ 7.350,00</li>
              <li>Fórmula redução: R$ 978,62 - (0,133145 × Base)</li>
            </ul>
          </div>
        </div>
        
        <h3>DECLARO PARA OS DEVIDOS FINS QUE O SERVIÇO FOI PRESTADO</h3>
        <div class="assinatura">
          <p>_______________________________________</p>
          <p>Assinatura do Prestador</p>
          <p style="margin-top: 20px;">Data: ${new Date().toLocaleDateString('pt-BR')}</p>
          <p> copyright aqmeira</p>
        

       </div>
      `;
      
      document.getElementById("mensagem").innerText = "Recibo gerado com sucesso!";
      setTimeout(() => { document.getElementById("mensagem").innerText = ""; }, 3000);
    }

    // Inicializar com "Não" selecionado
    document.addEventListener('DOMContentLoaded', function() {
      const radioNao = document.querySelector('input[name="possuiRPA"][value="nao"]');
      if (radioNao) radioNao.checked = true;
    });
  </script>
</body>
</html>